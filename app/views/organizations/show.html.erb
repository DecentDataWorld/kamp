<!-- ======= Breadcrumbs ======= -->
<section id="breadcrumbs" class="breadcrumbs">
  <div class="container">
    <ol>
      <li><%= link_to root_path do %>Home<% end %></li>
      <li><%= link_to users_path do %>Administration<% end %></li>
      <li><%= link_to organizations_path(:page => params[:page]) do %>Organizations<% end%></li>
      <li><%= @organization.name %></li>
    </ol>
  </div>
</section><!-- End Breadcrumbs -->

<!--=== About Section ===-->
<section id="about" class="about">
  <div class="container">
    <div class="row">
      <div class="col-3 border-end">
        <%= render partial: 'organizations/info', locals: { :short=>false } %>
      </div>

      <div class="col-9">
        <div class="row pb-1">
          <!-- Tab v1 -->
          <div class="tab-v1">
            <nav>
              <ul class="nav nav-tabs pb-2">
                <li class="pe-4"><a href="#resources" class="active" data-bs-toggle="tab" data-bs-target="#resources">Uploads<span class="badge badge-yellow"><%= @resource_count %></span></a></li>
                <% if (!@resources_pending.nil? and @resources_pending.count > 0) || (!@collections_pending.nil? and @collections_pending.count > 0) %>
                  <li class="pe-4"><a href="#resources_pending" data-bs-toggle="tab" data-bs-target="#resources_pending">Pending Approval</a></li>
                <% end %>
                <li class="pe-4"><a href="#members" data-bs-toggle="tab" data-bs-target="#members">Members</a></li>
                <% if (user_signed_in? and @organization.can_edit_organization(current_user)) or can? :manage, :all %>
                  <li class="dropdown pe-4 ps-4">
                    <a href="#" id="myTabDrop1" class="dropdown-toggle" data-bs-toggle="dropdown" data-bs-target="#manage">Manage <b class="caret"></b></a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="myTabDrop1">
                      <li><%= link_to org_private_resources_path(@organization) do %><i class="fa fa-lock"></i> Private Resources<% end %></li>
                      <li><%= link_to edit_organization_path(@organization) do %><i class="fa fa-edit"></i> Edit<% end %></li>
                      <% if can? :delete, @organization %>
                        <li class="divider"></li>
                        <li>
                          <%= link_to @organization, method: :delete, data: { confirm: 'Are you sure?' } do %>
                            <span class="glyphicon glyphicon-remove"></span> Delete
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  </li>
                <% end %>
              </ul>
            </nav>

            <div class="tab-content">
              <!--- RESOURCES TAB --->
              <div class="tab-pane fade show active pb-2" id="resources">
                <!--- Resource search and add (if permitted) within organization --->
                <div class="row pb-2">
                  <div class="<%= @organization.approved and @organization.users.exists?(current_user.id) ? 'col-11' : 'col-12' %>">
                    <%= form_for @organization, method: 'get', role: 'form', class: 'form-inline text-center pb-2' do %>
                      <div class="input-group">
                        <%= text_field_tag :resource_query, params[:resource_query], class: 'form-control', placeholder: 'Search ' + @organization.name + '\'s Resources', id: 'shop-search' %>
                        <button type="submit" class="btn btn-outline-primary"><i class="fa fa-search"></i></button>
                        <% if !params[:resource_query].nil? %>
                          <%= link_to organization_path(@organization), class: 'btn btn-outline-primary', role: "button" do %><i class="fa fa-refresh"></i><% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                  <% if @organization.approved and @organization.users.exists?(current_user.id) %>
                    <div class="col-1">
                      <%= link_to new_resource_path, class: 'btn btn-primary' do  %><i class="fa-solid fa-file-circle-plus"></i><% end %>
                    </div>
                  <% end %>
                  <h5 class="pt-2 ps-3"><% if !params[:resource_query].nil? %> <%= @resource_count %> resources <%= 'found with "' + params[:resource_query] + '"' %><% else %>&nbsp; <% end %> </h6>
                  <!--- End resource search and add --->

                  <!--- Resource and collections content --->
                  <div class="row">
                    <div class="col-sm-12">
                      <div class="tab-v1">
                        <ul class="nav nav-tabs">
                          <li class="nav-item"><a href="#inner_resources" class="nav-link nav-link-large <%= !@show_collections ? 'active' : ''%>" data-bs-toggle="tab" data-bs-target="#inner_resources">Resources</a></li>
                          <li class="nav-item"><a href="#inner_collections" class="nav-link nav-link-large  <%= @show_collections ? 'active' : ''%>" data-bs-toggle="tab" data-bs-target="#inner_collections">Collections</a></li>
                        </ul>
                        <div class="tab-content">
                          <div id="inner_resources" class="tab-pane show fade <%= !@show_collections ? 'active' : ''%>">
                            <% if @resources.count > 0 %>
                              <% @resources.each do |resource| %>
                                <%= render resource %>
                              <% end %>
                              <%= will_paginate @resources %>
                            <% else %>
                              <blockquote><i class="fa fa-thumbs-down"></i> No resources found with that combination</blockquote>
                              <div class="alert alert-info fade">
                                <h4>Let Us Know What We're Missing</h4>
                                <p>Didn't find what you were looking for? Take our survey and let us know what you would like to see on the KaMP</p>
                                <p><a class="btn-u btn-u-xs btn-u-blue" href="<%= survey_index_url %>"><i class="fa fa-angle-right"></i> Take the survey</a></p>
                              </div>
                            <% end %>
                          </div>
                      
                          <div id="inner_collections" class="tab-pane show fade <%= @show_collections ? 'active' : ''%>">
                            <% if @collections.count > 0 %>
                              <% @collections.each do |resource| %>
                                <%= render resource %>
                              <% end %>
                              <%= will_paginate @collections, :param_name => 'collection_page' %>
                            <% else %>
                              <blockquote><i class="fa fa-thumbs-down"></i> No collections found with that combination</blockquote>
                              <div class="alert alert-info fade">
                                <h4>Let Us Know What We're Missing</h4>
                                <p>Didn't find what you were looking for? Take our survey and let us know what you would like to see on the KaMP</p>
                                <p><a class="btn-u btn-u-xs btn-u-blue" href="<%= survey_index_url %>"><i class="fa fa-angle-right"></i> Take the survey</a></p>
                              </div>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div><!--- End resource and collections content --->
                </div>
              </div><!--- END RESOURCES TAB --->

              <!--- PENDING TAB --->
              <% if (!@resources_pending.nil? and @resources_pending.count > 0)  || (!@collections_pending.nil? and @collections_pending.count > 0) %>
                <div class="tab-pane fade" id="resources_pending">
                  <div class="row-fluid">
                    <div class="col-sm-12">
                      <h4>Resources</h4>
                      <% if @resources_pending.count > 0 %>
                        <p><%= @resources_pending.count %> resource(s) pending approval</p>
                        <div class="card">
                          <div class="card-body">
                            <% @resources_pending.each do |resource| %>
                              <%= render resource %>
                            <% end %>
                          </div>
                        </div>
                      <% else %>
                        <p>No pending resources found.</p>
                      <% end %>
                    </div>
                    <div class="col-sm-12">
                      <h4>Collections</h4>
                      <% if @collections_pending.count > 0 %>
                        <p><%= @collections_pending.count %> collection(s) pending approval</p>
                        <div class="card">
                          <div class="card-body">
                            <% @collections_pending.each do |resource| %>
                              <%= render resource %>
                            <% end %>
                          </div>
                        </div>
                      <% else %>
                        <p>No pending collections found.</p>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %><!--- END PENDING TAB --->

              <!--- MEMBERS TAB --->
              <div class="tab-pane fade" id="members">
                <div class="row">
                  <div class="col-sm-12">
                    <div class="tab-v1">
                      <ul class="nav nav-tabs">
                        <li class="nav-item"><a href="#pending_users" class="nav-link nav-link-large active" data-bs-toggle="tab" data-bs-target="#pending_users">Pending Applications</a><li>
                        <li class="nav-item"><a href="#users" class="nav-link nav-link-large" data-bs-toggle="tab" data-bs-target="#users">Current Users</a></li>
                      </ul>
                      <div class="tab-content">
                        <div id="pending_users" class="tab-pane show fade active">
                          <% if @organization.can_manage_users(current_user) or can? :manage, :all %>
                            <%= link_to "Add Member", organization_add_user_path(@organization), class: 'btn btn-outline-primary float-end' %>
                          <% end %>
                          <% if (@organization.can_manage_users(current_user) or can? :manage, :all) and @pending_applications.count > 0 %>
                            <table class="table table-striped table-hover" data-controller="table-sort">
                              <thead>
                                <th><%=t('activerecord.attributes.user.name')%></th>
                                <th><%=t('activerecord.attributes.user.email')%></th>
                                <th><%=t('activerecord.attributes.user.kamp_role')%></th>
                              </thead>
                              <tbody>
                                <% @pending_applications.each do |pa| %>
                                  <tr>
                                    <td><%= link_to pa.user.name, user_path(pa.user, :page => params[:page]) %></td>
                                    <td><%= pa.user.email %></td>
                                    <td><%= pa.user.roles.pluck(:name).join(', ').titleize %></td>
                                    <td><%= link_to("Approve", organization_process_application_path(:id=> pa.id, :result => "approve"), :data => { :confirm => "You are about to accept this membership application\n\nAre you sure?" }, :class => 'btn btn-outline-primary btn-sm float-end') %></td>
                                    <td><%= link_to("Deny", organization_process_application_path(:id=> pa.id, :result => "deny"), :data => { :confirm => "Are you sure you would like to deny this application?" }, :class => 'btn btn-outline-danger btn-sm float-end') %></td>
                                  </tr>
                                <% end %>
                              </tbody>
                            </table>
                            <% if @pending_applications.count > 30 %>
                              <div class="apple_pagination">
                                <%= will_paginate @users %>
                              </div>
                            <% end %>
                          <% end %>
                        </div>
                        <div id="users" class="tab-pane show fade ">
                          <p>Users that register with a <b>verified <%= @organization.domain if !@organization.domain.nil?  %></b> email address will automatically become members of this organization.</p>
                          <% if @organization.users_organizations.count > 0 %>
                            <table class="table table-striped table-hover" data-controller="table-sort">
                              <thead>
                                <th><%=t('activerecord.attributes.user.name')%></th>
                                <th><%=t('activerecord.attributes.user.email')%></th>
                                <th><%=t('activerecord.attributes.user.kamp_role')%></th>
                                <th><%=t('activerecord.attributes.user.organizations')%></th>
                              </thead>
                              <tbody>
                                <% @users.each do |u| %>
                                  <tr>
                                    <td><%= link_to u.name, user_path(u, :page => params[:page]) %></td>
                                    <td><%= u.email %></td>
                                    <td><%= u.roles.pluck(:name).join(', ').titleize %></td>
                                    <td><% if !u.organizations.nil? %>
                                      <% u.users_organizations.each do |uo| %>
                                        <%= link_to uo.organization.name, organization_path(uo.organization) %> (<%= uo.role %>)<br>
                                      <% end %>
                                    <% end %></td>
                                    <td class="text-center"><%= button_to deactivate_user_path(u), method: :put, remote: true, class: 'btn btn-outline-danger btn-sm', role: "button" do %>Deactivate<% end %></td>
                                  </tr>
                                <% end %>
                              </tbody>
                            </table>
                            <% if @users.count > 30 %>
                              <div class="apple_pagination">
                                <%= will_paginate @users %>
                              </div>
                            <% end %>
                          <% else %>
                              <p>This organization has no members yet.</p>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div><!--- END MEMBERS TAB --->
          
            </div>
          </div>
        </div>
        <!-- End Tab v1 -->


      </div>
    </div>
  </div>
</section>